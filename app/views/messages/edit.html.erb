<div class="reply-header">
  <div class="collapsible-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" data-target="section1">
    <h1 class="reply-title" style="margin: 0;">Prends donc un peu de temps pour</h1>
  </div>
  <div id="section1" class="collapsible-content" style="transition: max-height 0.3s ease; overflow: hidden;">
    <div class="reply-avatar-block" style="margin-top: 10px;">
      <% if @message.contact.photo.attached? %>
        <%= image_tag @message.contact.photo.variant(resize_to_fill: [38, 38]), class: "avatar-mobile ms-2" %>
      <% else %>
        <%= image_tag "default-avatar.png", class: "avatar-mobile" %>
      <% end %>
      <span class="reply-contact-name"><%= @message.contact.name %></span>
    </div>
  </div>
</div>

<div class="msg-bubble-pink mb-3">
  <div class="collapsible-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" data-target="section2">
    <div class="reply-block-title" style="margin: 0;">Dernier message non-répondu</div>
    <span class="toggle-arrow" style="font-size: 1.5em;">˅</span>
  </div>
  <div id="section2" class="collapsible-content" style="transition: max-height 0.3s ease; overflow: hidden;">
    <div class="card-mobile msg-inner-bubble mb-0" style="margin-top: 10px;">
      <div class="message-content"><%= @message.content %></div>
      <div class="message-date text-end">Il y a <%= time_ago_in_words(@message.created_at) %></div>
    </div>
  </div>
</div>

<% if @history_messages.present? %>
  <div class="msg-bubble-pink mb-2">
    <div class="collapsible-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" data-target="section3">
      <div class="reply-block-title" style="margin: 0;">
        <%= @message.contact.name %> fait partie de votre entourage proche !<br>
        Voici un résumé de vos derniers échanges :
      </div>
      <span class="toggle-arrow" style="font-size: 1.5em;">▾</span>
    </div>
    <div id="section3" class="collapsible-content" style="transition: max-height 0.3s ease; overflow: hidden;">
      <% @history_messages.each do |m| %>
        <div class="card-mobile msg-inner-bubble mb-1">
          <div class="message-content"><%= m.content %></div>
          <div class="message-date text-end">Il y a <%= time_ago_in_words(m.created_at) %></div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<div class="msg-bubble-pink mb-3">
  <div class="reply-block-title">Modification de la réponse à envoyer :</div>
  <div class="card-mobile msg-inner-bubble mb-0">
    <%= form_with(model: @message, local: true) do |form| %>
      <div class="mb-3">
        <%= form.label :content, "Votre réponse" %>
        <%= form.text_area :content, value: @message.content.presence || @message.ai_draft, rows: 5, class: "input-mobile" %>
      </div>
      <%= form.submit "Envoyer", class: "btn btn-pink reply-btn edit-form-btn" %>
    <% end %>
  </div>
</div>

<%= render 'shared/navbar_bottom' %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.collapsible-header').forEach(function(header) {
      header.addEventListener('click', function() {
        const targetId = header.dataset.target;
        const content = document.getElementById(targetId);
        const arrow = header.querySelector('.toggle-arrow');

        if (content.style.maxHeight && content.style.maxHeight !== "0px") {
          // Collapse
          content.style.maxHeight = "0";
          arrow.textContent = "▾";  // Flèche vers le bas
        } else {
          // Expand
          content.style.maxHeight = content.scrollHeight + "px";
          arrow.textContent = "▴";  // Flèche vers le haut
        }
      });
    });

    // Initial collapse the sections if you want (optional)
    ['section1', 'section2'].forEach(function(id) {
      const el = document.getElementById(id);
      if(el) {
        el.style.maxHeight = el.scrollHeight + "px"; // start expanded
      }
    });
  });
</script>
