<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="dashboard-title-card">
      <div class="dashboard-title-row">
        <%= image_tag "logo.png", alt: "Logo Rekonect", class: "logo-image" %>
        <div class="dashboard-title-text">
          <p>Bon retour <%= @user.username %></p>
          <div class="dashboard-welcome">Prends le temps de prendre des nouvelles de tes proches.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="xp-bar-container">
    <div class="xp-bar-logo">
      <%= image_tag "xp.png", class: "xp-bar-icon" %>
      <div class="xp-level">
        <span class="xp-level-label">NIVEAU</span>
        <span class="xp-level-number"><%= @user.level %></span>
      </div>
    </div>
    <div class="xp-bar">
      <div class="xp-bar-fill" style="width: <%= @user.xp_percent %>%"></div>
      <span class="xp-bar-progress"><%= @user.xp_progress %>/<%= @user.xp_for_next_level %> XP</span>
    </div>
  </div>
</div>

<% main_msg = @main_message || Message.where("(sender_id = :id OR receiver_id = :id) AND status = :status AND (dismissed = false OR dismissed IS NULL)", id: current_user.id, status: Message.statuses[:received]).last %>
<% if main_msg %>
  <div class="main-message-card">
    <div class="main-message-title d-flex justify-content-between align-items-center" onclick="toggleBlock('last-message-bubble', 'icon-last')">
      <p class="priority-msg">Hey! N'hÃ©sites pas Ã  rÃ©pondre Ã  <%= main_msg.contact.name %></p>
      <span id="icon-last" style="cursor:pointer;">ðŸ”»</span>
    </div>

    <div id="last-message-bubble" class="main-message-bubble">
      <div class="message-content">
        <%= main_msg.content %>
      </div>
      <div class="message-date">
        Il y a <%= time_ago_in_words(main_msg.created_at) %>
      </div>
    </div>

    <%= link_to "Rekonect", reply_message_path(main_msg), class: "btn-reply btn-pink main-message-btn" %>
  </div>
<% end %>

<%# --- Et sinon ? --- %>
<% quick_msgs = @quick_messages %>
<% if quick_msgs.any? %>
  <div class="quick-contacts-card">
    <div>
    <p class="quick-contacts-title">Qui d'autre ?</p>
    </div>

    <div class="slider-container">
      <button class="arrow left"><</button>

      <div class="quick-contacts-list">
        <% quick_msgs.each do |msg| %>
          <%= link_to rekonect_message_path(msg), class: "quick-card" do %>
            <div class="quick-contact">
              <div class="contact-content">
                <% if msg.contact.photo.attached? %>
                  <%= image_tag msg.contact.photo, class: "avatar-mobile mb-1", alt: msg.contact.name %>
                <% else %>
                  <%= image_tag "default-avatar.png", class: "avatar-mobile mb-1", alt: msg.contact.name %>
                <% end %>
              </div>
              <div class="contact-name"><%= msg.contact.name %></div>
              <div class="contact-date">
                <p>Il y a <%= time_ago_in_words(msg.created_at) %></p>
              </div>
              <div class="btn-sinon btn-sm mt-1 text-center">Rekonect</div>
            </div>
          <% end %>
        <% end %>
      </div>

      <button class="arrow right">></button>
    </div>

  </div>
<% end %>


<%# --- Badges et feedback XP --- %>
<h2 class="badge-header mb-2">Mes badges :</h2>
<div class="badges-list mb-2">
  <% @badges.each do |badge| %>
    <div class="card-mobile mb-2 d-flex align-items-center">
      <% if badge.image.attached? %>
        <%= image_tag badge.image, class: "badge-icon me-3", alt: badge.title %>
      <% else %>
        <%= image_tag "badge.png", class: "badge-icon me-3", alt: badge.title %>
      <% end %>

      <div class="badge-content">
        <div class="fw-bold"><%= badge.title %></div>
        <div class="text-muted small"><em>Condition : <%= badge.condition_description %></em></div>
      </div>
    </div>
  <% end %>
</div>

<%= link_to "Voir tous mes messages", messages_path, class: "btn btn-pink mb-3 w-100" %>

<%= render "shared/navbar_bottom" %>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const slider = document.querySelector(".quick-contacts-list");
  const cards = document.querySelectorAll(".quick-card");
  const leftArrow = document.querySelector(".arrow.left");
  const rightArrow = document.querySelector(".arrow.right");

  if (!slider || !cards.length) return;

  let currentIndex = 0;
  const totalCards = cards.length;

  function updateSlider() {
    slider.style.transform = `translateX(-${currentIndex * 100}%)`;
  }

  leftArrow?.addEventListener("click", () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateSlider();
    }
  });

  rightArrow?.addEventListener("click", () => {
    if (currentIndex < totalCards - 1) {
      currentIndex++;
      updateSlider();
    }
  });

  updateSlider(); // init
});
</script>

<script>
function toggleBlock(bubbleId, iconId) {
  const bubble = document.getElementById(bubbleId);
  const icon = document.getElementById(iconId);

  if (!bubble || !icon) return;

  if (bubble.style.display === "none" || bubble.style.display === "") {
    bubble.style.display = "block";
    icon.textContent = "ðŸ”º"; // flÃ¨che vers le haut (inversÃ©e)
  } else {
    bubble.style.display = "none";
    icon.textContent = "ðŸ”»"; // flÃ¨che vers le bas
  }
}
</script>
